@{
    Layout = "~/Views/Shared/_LayoutFinlab.cshtml";
    ViewData["Title"] = "Invoice Reminders";
}

<div class="content-body default-height">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xl-12">
                <div class="page-titles">
                    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="javascript:void(0);">Dashboard</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Invoice Reminders</li>
                        </ol>
                    </nav>
                    <div class="d-flex flex-wrap my-2 my-sm-0">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addReminderModal">
                            <i class="fas fa-plus me-2"></i>Add Reminder
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reminder Summary Cards -->
        <div class="row">
            <div class="col-xl-3 col-lg-6 col-sm-6">
                <div class="widget-stat card">
                    <div class="card-body p-4">
                        <div class="media ai-icon">
                            <span class="mr-3 ai-icon bg-danger">
                                <i class="fas fa-exclamation-triangle"></i>
                            </span>
                            <div class="media-body">
                                <h3 class="mb-0 text-danger"><span class="counter">@ViewBag.OverdueCount</span></h3>
                                <p class="mb-0">Overdue Invoices</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-sm-6">
                <div class="widget-stat card">
                    <div class="card-body p-4">
                        <div class="media ai-icon">
                            <span class="mr-3 ai-icon bg-warning">
                                <i class="fas fa-clock"></i>
                            </span>
                            <div class="media-body">
                                <h3 class="mb-0 text-warning"><span class="counter">@ViewBag.DueTodayCount</span></h3>
                                <p class="mb-0">Due Today</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-sm-6">
                <div class="widget-stat card">
                    <div class="card-body p-4">
                        <div class="media ai-icon">
                            <span class="mr-3 ai-icon bg-info">
                                <i class="fas fa-calendar-week"></i>
                            </span>
                            <div class="media-body">
                                <h3 class="mb-0 text-info"><span class="counter">@ViewBag.DueThisWeekCount</span></h3>
                                <p class="mb-0">Due This Week</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-6 col-sm-6">
                <div class="widget-stat card">
                    <div class="card-body p-4">
                        <div class="media ai-icon">
                            <span class="mr-3 ai-icon bg-success">
                                <i class="fas fa-bell"></i>
                            </span>
                            <div class="media-body">
                                <h3 class="mb-0 text-success"><span class="counter" id="totalReminders">0</span></h3>
                                <p class="mb-0">Total Reminders</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reminders Table -->
        <div class="row">
            <div class="col-xl-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">Active Reminders</h4>
                        <div class="card-toolbar">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshReminders()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="remindersTable">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Amount</th>
                                        <th>Due Date</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="remindersTableBody">
                                    <!-- Reminders will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Reminder Modal -->
<div class="modal fade" id="addReminderModal" tabindex="-1" aria-labelledby="addReminderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addReminderModalLabel">Add New Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addReminderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="invoiceNumber">Invoice Number</label>
                                <input type="text" class="form-control" id="invoiceNumber" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="clientName">Client Name</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="amount">Amount</label>
                                <input type="number" class="form-control" id="amount" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="dueDate">Due Date</label>
                                <input type="date" class="form-control" id="dueDate" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="priority">Priority</label>
                                <select class="form-control" id="priority" required>
                                    <option value="Low">Low</option>
                                    <option value="Medium">Medium</option>
                                    <option value="High">High</option>
                                    <option value="Critical">Critical</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="reminderDate">Reminder Date</label>
                                <input type="date" class="form-control" id="reminderDate">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea class="form-control" id="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveReminder()">Save Reminder</button>
            </div>
        </div>
    </div>
</div>

@section Finlab_script {
    <script>
        $(document).ready(function() {
            loadReminders();
            updateReminderCount();
            
            // Auto-refresh every 5 minutes
            setInterval(function() {
                loadReminders();
                updateReminderCount();
            }, 300000);
        });
        
        function loadReminders() {
            $.get('/Reminder/GetReminders', function(data) {
                const tbody = $('#remindersTableBody');
                tbody.empty();
                
                data.forEach(function(reminder) {
                    const row = createReminderRow(reminder);
                    tbody.append(row);
                });
            });
        }
        
        function createReminderRow(reminder) {
            const dueDate = new Date(reminder.dueDate);
            const today = new Date();
            const isOverdue = dueDate < today;
            const isDueToday = dueDate.toDateString() === today.toDateString();
            
            let statusClass = 'badge-light';
            let statusText = reminder.status;
            
            if (isOverdue) {
                statusClass = 'badge-danger';
                statusText = 'Overdue';
            } else if (isDueToday) {
                statusClass = 'badge-warning';
                statusText = 'Due Today';
            }
            
            let priorityClass = 'badge-light';
            switch(reminder.priority) {
                case 'Critical': priorityClass = 'badge-danger'; break;
                case 'High': priorityClass = 'badge-warning'; break;
                case 'Medium': priorityClass = 'badge-info'; break;
                case 'Low': priorityClass = 'badge-secondary'; break;
            }
            
            return `
                <tr>
                    <td><strong>${reminder.invoiceNumber}</strong></td>
                    <td>${reminder.clientName}</td>
                    <td>$${reminder.amount.toLocaleString()}</td>
                    <td>
                        <span class="${isOverdue ? 'text-danger' : isDueToday ? 'text-warning' : ''}">
                            ${new Date(reminder.dueDate).toLocaleDateString()}
                        </span>
                    </td>
                    <td><span class="badge ${priorityClass}">${reminder.priority}</span></td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-success" onclick="markAsPaid(${reminder.id})" title="Mark as Paid">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="sendReminder(${reminder.id})" title="Send Reminder">
                                <i class="fas fa-bell"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="viewDetails(${reminder.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="confirmInvoice(${reminder.id})" title="Confirm Invoice">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        function updateReminderCount() {
            $.get('/Reminder/GetReminderCount', function(data) {
                $('#totalReminders').text(data.count);
            });
        }
        
        function refreshReminders() {
            loadReminders();
            updateReminderCount();
        }
        
        function markAsPaid(id) {
            if (confirm('Mark this invoice as paid?')) {
                $.post('/Reminder/MarkAsPaid', { id: id }, function(data) {
                    if (data.success) {
                        loadReminders();
                        updateReminderCount();
                        showAlert('Invoice marked as paid successfully!', 'success');
                    } else {
                        showAlert('Failed to mark invoice as paid.', 'danger');
                    }
                });
            }
        }
        
        function sendReminder(id) {
            if (confirm('Send reminder for this invoice?')) {
                $.post('/Reminder/SendReminder', { id: id }, function(data) {
                    if (data.success) {
                        loadReminders();
                        showAlert('Reminder sent successfully!', 'success');
                    } else {
                        showAlert('Failed to send reminder.', 'danger');
                    }
                });
            }
        }
        
        function confirmInvoice(id) {
            if (confirm('Confirm this invoice?')) {
                $.post('/Reminder/ConfirmInvoice', { id: id }, function(data) {
                    if (data.success) {
                        loadReminders();
                        showAlert('Invoice confirmed successfully!', 'success');
                    } else {
                        showAlert('Failed to confirm invoice.', 'danger');
                    }
                });
            }
        }
        
        function viewDetails(id) {
            // Implement view details functionality
            alert('View details for reminder ID: ' + id);
        }
        
        function saveReminder() {
            const formData = {
                invoiceNumber: $('#invoiceNumber').val(),
                clientName: $('#clientName').val(),
                amount: parseFloat($('#amount').val()),
                dueDate: $('#dueDate').val(),
                priority: $('#priority').val(),
                reminderDate: $('#reminderDate').val() || null,
                notes: $('#notes').val()
            };
            
            $.ajax({
                url: '/Reminder/CreateReminder',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(data) {
                    if (data.success) {
                        $('#addReminderModal').modal('hide');
                        $('#addReminderForm')[0].reset();
                        loadReminders();
                        updateReminderCount();
                        showAlert('Reminder created successfully!', 'success');
                    } else {
                        showAlert('Failed to create reminder: ' + data.message, 'danger');
                    }
                },
                error: function() {
                    showAlert('Failed to create reminder.', 'danger');
                }
            });
        }
        
        function showAlert(message, type) {
            const alertDiv = $(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);
            
            $('.content-body').prepend(alertDiv);
            
            setTimeout(function() {
                alertDiv.alert('close');
            }, 5000);
        }
    </script>
}
